---
title: "AWS PrivateLinkとVPCエンドポイントの整理"
date: 2024-09-18T07:15:00
mermaid: true
weight: 7
tags:
  - AWS
  - PrivateLink
  - VPC
  - Cloud Networking
  - Security
  - Interface Endpoints
  - Gateway Endpoints
  - AWS Architecture
description: ""
---

PrivateLinkについてドキュメントを読んだので、自分用にメモをまとめました。

## 概要

**AWS PrivateLink**は、VPC間、オンプレミス環境からの接続、またはAWSサービスへのプライベート接続を提供します。これにより、パブリックインターネットを介さずに、安全にサービスにアクセスすることが可能です。

### 用語の定義

- **Service Providers**  
  サービスの所有者であり、サービスを提供する主体です。AWS自身、AWSパートナー、その他のAWSアカウントなどが該当します。

- **Service Consumers**  
  サービスの利用者であり、エンドポイントサービスにアクセスする人やシステムのことです。

## VPCエンドポイントとエンドポイントサービスの違い

AWSのVPCには、以下の2種類のサービスがあります：

1. **エンドポイントサービス (Endpoint Services)**  
   Service Providersが、サービスコンシューマに向けて提供するものです。

2. **VPCエンドポイント (VPC Endpoints)**  
   サービスコンシューマが、Service Providersの提供するサービスに接続するために使用します。VPCエンドポイントには、以下の3つの種類があります。

## Endpoint Services

- **ロードバランサーの指定**  
  Service Providersは、エンドポイントサービスを作成する際に特定のロードバランサーを指定する必要があります。

- **リクエストのルーティング**  
  ロードバランサーは、サービスコンシューマから受け取ったリクエストを、目的のサービスへルーティングします。

- **アクセス許可の設定**  
  デフォルトでは、エンドポイントサービスはサービスコンシューマに対して利用可能ではありません。特定のAWSプリンシパルに接続を許可する権限を追加する必要があります。

- **サービス名の管理**  
  各エンドポイントサービスは、一意のサービス名で識別されます。サービスコンシューマはVPCエンドポイントを作成する際に、このサービス名を指定する必要があります。Service Providersは、サービス名をサービスコンシューマと共有する必要があります。

## VPC Endpoints

**VPCエンドポイント**は、サービスコンシューマがエンドポイントサービスに接続するために作成します。

### VPCエンドポイントの種類

1. **Interface Endpoints (インターフェースエンドポイント)**  
   エンドポイントサービスに向けてTCPトラフィックを流すためのものです。DNSを使用して、エンドポイントサービスの宛先を解決します。

2. **Gateway Load Balancer Endpoints (ゲートウェイロードバランサーエンドポイント)**  
   プライベートIPアドレスを使用し、レイヤー3またはレイヤー4で動作します。受信したトラフィックを複数のアベイラビリティーゾーン内のターゲットに送信し、負荷分散します。

3. **Gateway Endpoints (ゲートウェイエンドポイント)**  
   Amazon S3やDynamoDBへのトラフィックを流すために使用します。ゲートウェイエンドポイントはAWS PrivateLinkを使用せず、ルートテーブルを介してトラフィックを送ります。

### エンドポイントネットワークインターフェース

エンドポイントネットワークインターフェースは、**リクエスターが管理**するネットワークインターフェースです。エンドポイントサービスへのトラフィックのエントリポイントとして機能し、以下の特徴があります：

- **IPv4/IPv6サポート**  
  IPv4アドレスとIPv6アドレスの両方をサポートしています。ただし、IPv6アドレスを持つ場合、`denyAllIgwTraffic`設定が自動的に有効になり、インターネットからのアクセスはできません。ただし、AWS内部ネットワーク内からのアクセスは可能です。

- **IPアドレスの固定**  
  一度設定されると、エンドポイントネットワークインターフェースのIPアドレスはエンドポイントのライフタイム中、変更されることはありません。

## AWS PrivateLink接続

**AWS PrivateLink**は、VPCエンドポイント（サービスコンシューマ側）とエンドポイントサービス（Service Providers側）をプライベートに接続する仕組みです。VPCエンドポイントからエンドポイントサービスへのトラフィックはすべてAWSの内部ネットワークを通じて通信され、パブリックインターネットは経由しません。

- **パブリックホストゾーン**  
  パブリックホストゾーン内のレコードは、インターネット上でのトラフィックを制御します。

- **プライベートホストゾーン**  
  プライベートホストゾーン内のレコードは、特定のVPC内のみでトラフィックをルーティングします。

## スプリットホライズンDNS

**スプリットホライズンDNS**とは、同じドメイン名を使って、パブリックウェブサイトとプライベートなVPC内のエンドポイントサービスの両方に異なる解決結果を返す方法です。具体的には：

- **VPC内のDNSリクエスト**  
  VPCエンドポイントのプライベートIPアドレスに解決されます。

- **外部からのリクエスト**  
  パブリックエンドポイントに解決されます。

この仕組みにより、同じドメイン名でパブリックとプライベートのサービスを共存させることが可能です。

## VPCエンドポイントとエンドポイントサービスの組み合わせ

VPCエンドポイントとエンドポイントサービスを組み合わせて使用することで、以下のようなメリットがあります：

- **プライベート接続の確立**  
  別のVPCや別のAWSアカウントから、インターネットを介さずにプライベートにサービスを利用できます。

- **マルチアカウント構成や異なるVPC間での接続**  
  特に、マルチアカウント環境や異なるVPC間での安全な接続が必要な場合に有効です。

### 具体的な利用例

**あるVPCにホストされた社内APIに対して、他のVPCからアクセスする場合**の設定手順：

1. **サービス提供VPC**にエンドポイントサービスを作成し、他のVPCに対してそのサービスを公開します。
2. **アクセス側VPC**でインターフェースエンドポイントを作成し、エンドポイントサービスに接続します。

---

## 参考サイト

- [AWS PrivateLink concepts](https://docs.aws.amazon.com/vpc/latest/privatelink/concepts.html)
